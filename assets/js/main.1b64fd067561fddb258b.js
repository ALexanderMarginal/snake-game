(()=>{"use strict";(()=>{const t=document.body.offsetWidth/3;class e{constructor(e){this.size=e,this.step=0,this.ctx=(()=>{const e=document.createElement("canvas");e.width=t,e.height=t;const s=document.getElementById("root");return s&&s.appendChild(e),e.getContext("2d")})(),this.step=t/this.size}get fullSize(){return this.size*this.step}}const s=(t,e)=>Math.floor(Math.random()*(e-t)+t);var i,a;!function(t){t.Background="#333",t.Border="#000",t.Line="#444",t.Snake="#0f0",t.Apple="#f00"}(i||(i={})),function(t){t.ArrowUp="ArrowUp",t.ArrowDown="ArrowDown",t.ArrowLeft="ArrowLeft",t.ArrowRight="ArrowRight",t.Space=" "}(a||(a={}));const n={[a.ArrowUp]:a.ArrowDown,[a.ArrowLeft]:a.ArrowRight,[a.ArrowRight]:a.ArrowLeft,[a.ArrowDown]:a.ArrowUp,[a.Space]:a.Space};class r{constructor(t,e){this.canvas=t,this.boardSize=e,this.coordinates=[],this.setInitialCoordinate()}setInitialCoordinate(){const t=Math.floor(this.boardSize/2)-1;this.coordinates=[{x:t,y:t}]}get coords(){return this.coordinates}render(){this.canvas.ctx.fillStyle=i.Snake;for(const t of this.coordinates)this.canvas.ctx.fillRect(t.x*this.canvas.step,t.y*this.canvas.step,this.canvas.step,this.canvas.step)}move(t,e){const s=this.coordinates[this.coordinates.length-1],i=e.checkCollision(this.coordinates),n=i?this.coordinates:this.coordinates.slice(1);switch(i&&e.make(),t){case a.ArrowRight:this.coordinates=[...n,{x:s.x+1>=this.canvas.size?0:s.x+1,y:s.y}];break;case a.ArrowDown:this.coordinates=[...n,{x:s.x,y:s.y+1>=this.canvas.size?0:s.y+1}];break;case a.ArrowLeft:this.coordinates=[...n,{x:s.x?s.x-1:this.canvas.size-1,y:s.y}];break;case a.ArrowUp:default:this.coordinates=[...n,{x:s.x,y:s.y?s.y-1:this.canvas.size-1}]}}checkCollision(){const t=this.coordinates[this.coordinates.length-1];for(let e=0;e<this.coordinates.length-1;e++){const s=this.coordinates[e];if(t.x===s.x&&t.y===s.y)return!0}return!1}}class o{constructor(t,e){this.canvas=t,this.snake=e}checkCollision(t){var e;for(const s of t)if(s.x===(null===(e=this.coordinate)||void 0===e?void 0:e.x)&&s.y===this.coordinate.y)return!0;return!1}make(){let t;for(;!t;){const e={x:s(0,this.canvas.size-1),y:s(0,this.canvas.size-1)};for(const s of this.snake.coords)if(s.x!==e.x&&s.y!==e.y){t=e;break}}this.coordinate=t}render(){this.coordinate&&(this.canvas.ctx.fillStyle=i.Apple,this.canvas.ctx.fillRect(this.coordinate.x*this.canvas.step,this.coordinate.y*this.canvas.step,this.canvas.step,this.canvas.step))}}class h{constructor(t){this.canvas=t}render(){this.canvas.ctx.clearRect(0,0,this.canvas.fullSize,this.canvas.fullSize),this.canvas.ctx.fillStyle=i.Background,this.canvas.ctx.fillRect(0,0,this.canvas.fullSize,this.canvas.fullSize),this.canvas.ctx.beginPath(),this.canvas.ctx.strokeStyle=i.Line;for(let t=0;t<=this.canvas.fullSize;t+=this.canvas.step)this.canvas.ctx.moveTo(t,0),this.canvas.ctx.lineTo(t,this.canvas.fullSize),this.canvas.ctx.moveTo(0,t),this.canvas.ctx.lineTo(this.canvas.fullSize,t);this.canvas.ctx.stroke(),this.canvas.ctx.strokeStyle=i.Border,this.canvas.ctx.strokeRect(0,0,this.canvas.fullSize-1,this.canvas.fullSize-1)}}class c{constructor(t,s,i){this.speed=t,this.speedRate=s,this.boardSize=i,this.score=document.getElementById("score"),this.scoreCount=void 0,this.fail=document.getElementById("fail"),this.direction=a.ArrowUp,this.startHandler=this.startHandler.bind(this),this.keyboardHandler=this.keyboardHandler.bind(this),this.restart=this.restart.bind(this),this.canvas=new e(this.boardSize),this.board=new h(this.canvas),this.snake=new r(this.canvas,this.boardSize),this.apple=new o(this.canvas,this.snake),this.apple.make(),this.render(),this.initHandlers()}checkKeyboardEvent(t){return[a.ArrowUp,a.ArrowRight,a.ArrowDown,a.ArrowLeft].includes(t.key)}setSnakeLength(){var t;this.score&&this.scoreCount!==(null===(t=this.snake)||void 0===t?void 0:t.coords.length)&&this.snake&&(this.scoreCount=this.snake.coords.length,this.scoreCount%5||(this.speed=this.speed*(1-this.speedRate)),this.score.innerHTML=this.scoreCount?`Длина змеи ${this.scoreCount}`:"")}tick(){var t,e;if(this.apple){if(null===(t=this.snake)||void 0===t||t.move(this.direction,this.apple),null===(e=this.snake)||void 0===e?void 0:e.checkCollision())return void this.onFail();this.setSnakeLength()}this.render(),setTimeout((()=>this.tick()),this.speed)}restart(t){var e,s;t.key===a.Space&&(document.removeEventListener("keyup",this.restart),null===(e=this.fail)||void 0===e||e.classList.remove("active"),null===(s=this.snake)||void 0===s||s.setInitialCoordinate(),this.render(),this.initHandlers())}onFail(){var t;null===(t=this.fail)||void 0===t||t.classList.add("active"),document.addEventListener("keyup",this.restart)}initHandlers(){document.removeEventListener("keyup",this.keyboardHandler),document.addEventListener("keyup",this.startHandler)}startHandler(t){this.checkKeyboardEvent(t)&&(t.preventDefault(),t.stopPropagation(),this.direction=t.key,document.removeEventListener("keyup",this.startHandler),document.addEventListener("keyup",this.keyboardHandler),this.tick())}keyboardHandler(t){if(this.checkKeyboardEvent(t)){if(t.preventDefault(),t.stopPropagation(),n[t.key]===this.direction)return;this.direction=t.key}}render(){var t,e,s;null===(t=this.board)||void 0===t||t.render(),null===(e=this.apple)||void 0===e||e.render(),null===(s=this.snake)||void 0===s||s.render()}}new class{constructor(){var t;this.menu=document.getElementById("menu"),this.baseSpeed=500,this.speedRate=.05,this.boardSize=10,this.start=this.start.bind(this),null===(t=this.menu)||void 0===t||t.addEventListener("submit",this.start)}getSetting(t,e,s){const i=t.get(e);return i?Number(i):s}start(t){var e,s;t.preventDefault(),t.stopPropagation(),null===(e=this.menu)||void 0===e||e.removeEventListener("submit",this.start);const i=new FormData(t.target);this.baseSpeed=this.getSetting(i,"baseSpeed",this.baseSpeed),this.speedRate=this.getSetting(i,"speedRate",this.speedRate),this.boardSize=this.getSetting(i,"boardSize",this.boardSize),new c(this.baseSpeed,this.speedRate,this.boardSize),null===(s=this.menu)||void 0===s||s.classList.add("disabled")}}})()})();